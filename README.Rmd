---
title: "SpaceANOVA"
author: Souvik Seal
output: 
 github_document: 
  pandoc_args: --webtex=http://chart.apis.google.com/chart?cht=tx&chl=
bibliography: ref.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#",
  out.width = "100%",
  messages = FALSE,
  warnings = FALSE
)
```

This is an R package implementing the proposed method from the paper, "SpaceANOVA: Spatial co-occurrence analysis of cell types in multiplex imaging data using point
process and functional ANOVA". It can be used to study differential spatial co-occurrence of pairs of cell types across multiple groups, such as case/control.

## Loading the package

We install and load the developmental version of SpaceANOVA from GitHub.

```{r loading packages, message=FALSE}

suppressMessages(devtools::install_github('sealx017/SpaceANOVA'))
require(spatstat)
require(tidyr)
require(fda.usc)
require(SpaceANOVA)

```

## Loading the example dataset

Next, we import the type 1 diabetis melitus (T1DM) IMC dataset [1]. The input data should have a simple form: a) rows should correspond to individual cells, and b) six columns should correspond to the group, subject, and image indices of the cell, along with it's x,y co-ordinates and cell type. 

```{r loading the marker expression, out.width = "50%"}

data("IMC_T1DM")
knitr::kable(head(IMC_T1DM), format="markdown")

```

## Compute the summary functions and perform association analysis

This function can be used to perform the entire analysis at one go, starting from summary function estimation to the univariate and multivariate FANOVA-based association analyses. 
The function takes several input parameters out of which the most important ones are displayed below. "fixed_r" corresponds to the grid values of radius r. "Summary_function" corresponds to which summary function to be used: g, K, or L.  "Hard_ths" corresponds to the lowest number of a particular cell type, say A, that an image can have (the image will be dropped if not for any pair of cell types involving A). "perm" is used to employ the permutation envelope-based adjustment to the summary functions in presence of holes in images and "nPerm" denotes the number of permutations to be used. "cores" is the number of cores to be used, if more than 1, mclapply (parallel package) is called. 


```{r Computing spatial summary functions, and performing both univariate and multivariate differential co-occurrence analysis, echo = T, results = T}

Final_result = All_in_one(data = IMC_T1DM, fixed_r = seq(0, 100, by = 5), Summary_function = "g", Hard_ths = 10, perm = TRUE, nPerm = 20, cores = 8)

```

## Extracting p-values 

We return to the analysis of multiplex imaging data. We compute the EQMI\* of all the subjects using the function QMI_all and store the values in a matrix whose every row corresponds to a subject. 

```{r P-valu extraction}


```

## Association testing using CoxPH model


Using the vector of estimated EQMI\* of all the subjects, we perform association analysis with two clinical outcomes, survival and recurrence. We have the outcomes, the time to death and the time to recurrence and the respective censoring indicators (= 0 for an event) as the columns of the matrix named clinical_data. We have one single covariate, Age in the same matrix. Below, we create a matrix named surv_dat with all the subject IDs and their survival outcomes, and another matrix named covariates with the subject IDs and available covariates which, in this case, is just Age. We then use the function Cox_PH to fit the proportional hazard (PH) model outputting a table of p-values. To add higher order terms in the PH model, change degree to > 1. 

```{r CoxPh model studying association between EQMI and survival}


```

## References

1\) Damond, N., Engler, S., Zanotelli, V. R., Schapiro, D., Wasserfall, C. H.,
Kusmartseva, I., Nick, H. S., Thorel, F., Herrera, P. L., Atkinson, M. A., et al.
(2019). A map of human type 1 diabetes progression by imaging mass cytometry.
Cell metabolism, 29(3), 755â€“768.

2\) Baddeley, A., Rubak, E., and Turner, R. (2015). Spatial point patterns: methodology and applications with R. CRC press.

3\) Zhang, J.-T. (2013). Analysis of variance for functional data. CRC press.



